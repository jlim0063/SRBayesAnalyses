---
title: "**NSF study Main Data Analyses**"

---

## Load libraries

```{r,echo=FALSE}

## Load Packages

## Data wrangling
library(dplyr)   
library(tidyr)
library(readxl)      # required for read_excel() method
library(glue)

## Visualisation libraries
library(ggplot2)
library(visreg)
library(ggsignif)    # For significance bars on ggplots

library(egg)         # required for ggarrange (panelling multiple ggplots)

## Modelling
library(lme4)        # required for `Lmer() and glmer()` methods
library(lmerTest)    # required for p-value approximations

library(emmeans)     # required to retrieve least-square estimates, using `lsmeans()` and `emmeans`


library(aod)         # required to call model comparison methods, such as `AIC`, `BIC`
library(car)         # required for Chi-square test of Coefficient Equality `linearHypothesis`
library(MuMIn)       # required for r.squaredGLMM() function
library(performance) # required for check_collinearity function
library(sjPlot)      # required for `tab_model(model)`, which provides a formatted output of the model in APA style.

library(DHARMa)      # required for residual inspection

# # Other reserve libraries
# library(piecewiseSEM)


# Turn off scientific notation
options(scipen = 20)

```

### Additional function definition
```{r}

# To retrieve standardised coefficients, if needed
lm.beta.lmer <- function(mod) {
   b <- fixef(mod)[-1]
   sd.x <- apply(getME(mod,"X")[,-1],2,sd)
   sd.y <- sd(getME(mod,"y"))
   b*sd.x/sd.y
}

# Calculate standardised Relative Decision Weights
calculate_relative_dw = function(LogLLA, LogBaserate){
  rdw = (LogLLA-LogBaserate)/(LogLLA + LogBaserate);
  return(rdw)
};

```

---
# Data Management Pt 1

```{r,echo=FALSE}

# Read data
nsf.data <- read_excel("./data/NSF_study_data/data_master.xlsx")

# Check for duplicates
nsf.data <- nsf.data[duplicated(nsf.data) == FALSE,]

# Convert Condition to factor
nsf.data$Condition <- factor(nsf.data$Condition,
                             levels = c("WR", "TSD", "SR"));
# Convert Session to factor variable
nsf.data$Session <- factor(nsf.data$Session,
                           levels = c(1, 2),
                           labels = c("1st", "2nd"));


```

# Data Management Pt 2
Inspecting the participant IDs show that there are some participants who did not complete both WR and their assigned conditions.

## Participant ID breakdown

```{r, echo=FALSE}
# Get number of participants that have each respective sleep condition
wr_pts  <- unique(nsf.data[nsf.data$Condition == 'WR', ]$PtID)
tsd_pts <- unique(nsf.data[nsf.data$Condition == 'TSD', ]$PtID)
sr_pts  <- unique(nsf.data[nsf.data$Condition == 'SR', ]$PtID)


# Sort order
wr_pts  <- sort(wr_pts, decreasing = FALSE);
tsd_pts <- sort(tsd_pts, decreasing = FALSE);
sr_pt   <- sort(sr_pts, decreasing = FALSE);

# Print number of participants by condition
length(wr_pts); length(tsd_pts); length(sr_pts)
# Print total number of participants in whole dataset
length(unique(nsf.data$PtID))


setdiff(sr_pts, wr_pts)             # SR participants missing WR data
setdiff(tsd_pts, wr_pts)            # TSD participants missing WR data
setdiff(wr_pts, c(sr_pts, tsd_pts)) # Participants with WR trials data, but missing their respective sleep loss trials data

# need to look at 41 again
```

From inspection of eligibility data:
- Data for #41 needs to be dropped completely due to not meeting age criteria. 
- The following data should be dropped due to idiosyncratic reasons for malperformance on task (e.g. fell asleep during task)
  - All trials for Participants 13, 22, 45
  - TSD trials for Participant 15
  - SR trials for Participant 22
  - WR trials for Participant 58



```{r, echo = FALSE}

# Store all inegligible participant IDs in one array.
nsf.ineligible_pts <- c(13, 22, 41, 45)

```

## Extract & concatenate participant `KSS` data

```{r, echo=FALSE}
nsf.temp.KSS <- read.csv("./data/NSF_study_data/KSS_data.csv")
nsf.temp.KSS <- nsf.temp.KSS[ , c("Subject", "Condition", 'KSS_wr', 'KSS_sl')];

# Create new KSS column in nsf.data
nsf.data$KSS <- NA;
pt_list      <-  unique(nsf.data$PtID);

# Loop through participant ids and extract KSS values from `nsf.kss.data`
for (id in pt_list){
  if(id %in% nsf.temp.KSS$Subject){
    KSS.WR <- nsf.temp.KSS[nsf.temp.KSS$Subject == id, ]$KSS_wr
    KSS.SL <- nsf.temp.KSS[nsf.temp.KSS$Subject == id, ]$KSS_sl
    nsf.data[nsf.data$PtID == id & nsf.data$Condition == "WR", ]$KSS             <- KSS.WR
    nsf.data[nsf.data$PtID == id & nsf.data$Condition %in% c("TSD", "SR"), ]$KSS <- KSS.SL
    print(glue("KSS data for Subject ID {id} added."))
  } else {
    print(glue("No KSS data for Subject ID {id} found."))
  }
}

# Remove placeholder variables from global
rm(pt_list); rm(nsf.temp.KSS)

```

## Extract & conctatenate sex data from original demographic data file, for participants that are missing sex data

```{r}

# Participants with missing demographic information
nsf.missing_sex <- unique(nsf.data[is.na(nsf.data$sex),]$PtID)
nsf.missing_age <- unique(nsf.data[is.na(nsf.data$age),]$PtID)
print(unique(c(nsf.missing_age, nsf.missing_sex)));


# View participants missing KSS data. 
a <- distinct(nsf.data, PtID, Condition,.keep_all = TRUE)
print(a[is.na(a$KSS)==TRUE, 2:3 ])
nsf.missing_kss <- a[is.na(a$KSS)==TRUE, 2:3 ]$PtID

# Add these participants to incomplete pt list
nsf.incomplete_pts <- unique(c(nsf.missing_age, nsf.missing_sex, nsf.missing_kss));

# Remove placeholder variables from global
rm(a)

```

---

# Analyses

```{r}

# Fill in missing demographic data if available
nsf.data[nsf.data$PtID == 60, 'age'] <- 19 
nsf.data[nsf.data$PtID == 60, 'sex'] <- 'M'
nsf.data[nsf.data$PtID == 50, 'age'] <- 33 
nsf.data[nsf.data$PtID == 50, 'sex'] <- 'F'
nsf.data[nsf.data$PtID == 3, 'age']  <- 20
nsf.data[nsf.data$PtID == 3, 'sex']  <- 'F'
nsf.data[nsf.data$PtID == 61, 'age'] <- 19
nsf.data[nsf.data$PtID == 61, 'sex'] <- 'M'
nsf.data[nsf.data$PtID == 59, 'age'] <- 23
nsf.data[nsf.data$PtID == 59, 'sex'] <- 'M'
nsf.data[nsf.data$PtID == 41, 'age'] <- 44
nsf.data[nsf.data$PtID == 41, 'sex'] <- 'M'


```

## Drop ineligible participants
```{r, echo = FALSE}
nsf.data <- nsf.data[!(nsf.data$PtID == 22 & nsf.data$Condition == 'SR'), ]  # Drop Participant 22's SR trials**
nsf.data <- nsf.data[!(nsf.data$PtID == 15 & nsf.data$Condition == 'TSD'), ] # Drop Participant 15's TSD trials**
nsf.data <- nsf.data[!(nsf.data$PtID == 58 & nsf.data$Condition == 'WR'), ]  # Drop Participant 58's WR trials

# Drop all participants in ineligible list
nsf.data <- nsf.data[!nsf.data$PtID %in% nsf.ineligible_pts, ]

```

## KSS model

```{r, echo = FALSE}

# Subset data such that each participant only has 1 KSS entry per condition
nsf.data.KSS <- distinct(nsf.data, PtID, Condition, .keep_all = TRUE)


```

```{r, echo = FALSE}
length(unique(nsf.data.KSS$PtID))
# Check KSS distribution
plot.nsf.KSS.hist   <- ggplot(nsf.data.KSS, aes(x = KSS)) + geom_density()

# Log transform KSS
nsf.data.KSS$logKSS  <- log(nsf.data.KSS$KSS)
nsf.data.KSS$sqrtKSS <- sqrt(nsf.data.KSS$KSS)
plot.nsf.logKSS.hist <- hist(nsf.data.KSS$logKSS)

# Build the KSS modelconf
m.nsf.KSS <- lmer(KSS ~ 1 + Condition+ (1|PtID), nsf.data.KSS)

# View output
tab_model(m.nsf.KSS)

```


#### Normality of Residuals check
```{r}

# Check residuals
sim_output <- simulateResiduals(m.nsf.KSS, plot = F); plotQQunif(sim_output);plotResiduals(sim_output)


```

### Plot KSS model
``` {r, echo = FALSE}

nsf.data.KSS.lsmeans <- as_tibble(lsmeans(m.nsf.KSS, specs = "Condition")) %>% 
  slice(match(c("WR", "SR", "TSD"), Condition)) %>%                  # Rearrange such that order is WR, SR, TSD
  mutate(Condition = factor(Condition, levels = c("WR","SR","TSD"))) # Factorize condition such that ggplot follows custom order

# Define plot 

nsf.plot.KSS.lsmeans <- ggplot(nsf.data.KSS.lsmeans, aes(x = Condition, y = lsmean)) +
  geom_col(fill = c("#999DA0", "#777B7E", "#C7C6C1"), colour = "black", linewidth =1) +
  scale_y_continuous(limits = c(0, 8)) +
  labs(x = "Condition", y = "KSS score") + 
  geom_errorbar(aes(ymin = nsf.data.KSS.lsmeans$lower.CL, ymax = nsf.data.KSS.lsmeans$upper.CL), color = "#222021", width = 0.2, linewidth = 1)+
  theme_classic() + theme(aspect.ratio = .75, axis.title = element_text(size = 18),  axis.text = element_text(size = 18), axis.line = element_line(linewidth = 2)) 
  # geom_text(aes(label = round(lsmean, 2)), position = position_dodge(1), vjust = -5, size = 5.5)

ggsave(
  plot = nsf.plot.KSS.lsmeans,
  filename = "img/nsf/KSS_score.png",
  bg = "transparent"
  )


```

## Accuracy model

```{r, echo = FALSE}
# Subset without noBrainers
nsf.data.exNB     <- nsf.data[nsf.data$NoBrainer == 0, ] # Remove ineligible pts


# Build accuracy model
m.nsf.ACC <- glmer(
  IsCorrect ~ 1 + Session + Condition + (1|PtID), 
  family = binomial('logit'),
  data = nsf.data.exNB
)



```

### Plot accuracy model
```{r, echo = FALSE}

# Code to call least-square marginal means on response scale
nsf.data.ACC <- as_tibble(emmeans(m.nsf.ACC, spec = c( "Condition"), type = "response"))
nsf.data.ACC$Condition <- factor(nsf.data.ACC$Condition, levels = c("WR", "SR", "TSD"))


nsf.plot.ACC <- ggplot(nsf.data.ACC, aes(x = factor(Condition, levels = c("WR","SR","TSD")), y = prob)) + 
  geom_point(size = 3) +
  scale_y_continuous(limits = c(0.5, 1)) +
  labs(x = "Condition", y = "Probability of Accurate Response") +
  scale_color_manual(values = c("#202A44", "#9F1D35")) + 
  geom_errorbar(aes(ymin = nsf.data.ACC$asymp.LCL, ymax = nsf.data.ACC$asymp.UCL), color = '#595959', width = 0.1) + 
  theme_bw()+theme(aspect.ratio = 0.75, axis.title = element_text(size=18), axis.text=element_text(size=15)) ;

ggsave(
  plot = nsf.plot.ACC,
  filename = "img/nsf/NSF_taskAccuracy.png",
  bg = "transparent"
  )



```


## Pooled probit model

```{r}


length(unique(nsf.data.exNB[nsf.data.exNB$Condition == 'TSD',]$PtID))
length(unique(nsf.data.exNB[nsf.data.exNB$Condition == 'SR', ]$PtID))
length(unique(nsf.data.exNB[nsf.data.exNB$Condition == 'WR', ]$PtID))
length(unique(nsf.data.exNB$PtID))


#Build pooled model that excludes NoBrainer trials
m.nsf.exNB <- glmer(PtResp ~ 1 + Condition*LogBaserate + Condition*LogLLA + 
                    (1  |PtID),             
                  family = binomial('probit'),
                  # control = glmerControl(boundary.tol = 1e10),
                  nsf.data.exNB);

table(nsf.data.exNB$Session)


# Example of simple effect of LogLLA for SR participant, using LogLLA during SR condition
# use pnorm() to convert into cumulative probability
pnorm(.54 + .71 - .15 )

pnorm(fixef(m.nsf.exNB)[1] + fixef(m.nsf.exNB)['LogBaserate'] + fixef(m.nsf.exNB)['ConditionSR:LogBaserate'] ) #- pnorm(fixef(m.nsf.exNB)[1])
pnorm(fixef(m.nsf.exNB))


tab_model(m.nsf.exNB)


```



#### Normality of Residuals check
```{r}
# Check residuals
sim_output <- simulateResiduals(m.nsf.exNB, plot = F); plotQQunif(sim_output);plotResiduals(sim_output)


```


### Chi-square test of coefficients
```{r, echo = false}
# Chi-square tests
linearHypothesis(m.nsf.exNB, c(" LogBaserate =  LogLLA"), rhs=NULL, test = c("Chisq"),
                 vcov.=NULL, singular.ok=FALSE, verbose=TRUE)

linearHypothesis(m.nsf.exNB, c("ConditionSR:LogBaserate  =   ConditionSR:LogLLA"), rhs=NULL,
                 test = c("Chisq"),
                 vcov.=NULL, singular.ok=FALSE, verbose=TRUE)

linearHypothesis(m.nsf.exNB, c("ConditionTSD:LogBaserate =  ConditionTSD:LogLLA"), test = "Chisq",
                 vcov.=NULL, singular.ok=FALSE, verbose=TRUE)





```


### Plot Decision Weights

```{r, echo = FALSE}

nsf.data.DW <- tibble(.rows = 6)
nsf.data.DW$condition <-  c("WR", "WR", "TSD", "TSD", "SR", "SR")
nsf.data.DW$information <-  c(rep(c("Evidence", "Base Rate"), 3))


nsf.data.DW$ coefficients <- c(0.71187, 1.38736,
                                        (0.711873 - 0.02729), (1.387346 - 0.0147 ),
                                        (0.711873 - 0.15188), (1.387346 - 0.21893)
                                        )


nsf.data.DW$ci_lower <- c(0.6392888, 1.2548631,
                                   0.5613523, 1.1481704,
                                   0.4401318, 0.9502206);

nsf.data.DW$ci_upper <- c(0.7844538490, 1.5198590053,
                                   0.8078151152, 1.597176358,
                                   0.6798578593, 1.386698082);
  
nsf.data.DW$condition <- factor(nsf.data.DW$condition, levels = c("WR","SR","TSD"))
nsf.data.DW$information <- factor(nsf.data.DW$information, levels = c("Base Rate", "Evidence"))


plot.nsf.DW <- ggplot(data = nsf.data.DW, aes( x = condition, y = coefficients, shape = information)) + 
  geom_point(size=  3, aes(shape = information)) +                          
  scale_y_continuous(limits = c(0, 2)) +                                      # Sets y axis range      
  labs(x = "Condition", y = "Decision Weight", shape = "Information") +        # Changes labels (axis titles and legend title)
  
  scale_shape_manual(values = c(17, 19)) +
  # scale_color_manual(labels = c("Draw Outcome", "Base Rate Odds"), values = c("#696969", "#3E424B"))+
  
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), color = '#595959', width = 0.2)+ # Add error bars
  theme_bw(base_size = 15) + theme(aspect.ratio =  1.2, axis.title = element_text(size = 15), axis.text = element_text(size = 15), panel.border = element_rect(linewidth = 2))  

# Save as png with transparent background
ggsave(plot = plot.nsf.DW,
       filename = "img/nsf/NSF_decisionWeights.png",
       bg = "transparent");

# Remove placeholder variables from global



```


### Plot Relative Decision Weights
```{r, echo = false}

# Calculate relative decision-weights

LogLLA      <- 0.711873
LogBaserate <- 1.38734


WR_RDW.nsf  <- calculate_relative_dw(LogLLA, LogBaserate);
TSD_RDW.nsf <- calculate_relative_dw(LogLLA - 0.027289, LogBaserate - 0.014667)
SR_RDW.nsf  <- calculate_relative_dw(LogLLA - 0.151878, LogBaserate - 0.218881)

nsf.temp.RDW           <- tibble(.rows = 3);
nsf.temp.RDW$condition <- c("WR", "SR", "TSD");
nsf.temp.RDW$condition <- factor(nsf.temp.RDW$condition, levels = c("WR", "SR", "TSD"))
nsf.temp.RDW$RDW       <- c(WR_RDW.nsf, SR_RDW.nsf,TSD_RDW.nsf);

plot.nsf.RDW <- ggplot(data = nsf.temp.RDW, aes(x = condition, y = RDW))+
  geom_bar(
    stat = 'identity',
    width = 0.5, fill = c("#999DA0", "#777B7E","#C7C6C1"), colour = "#212121"
  )+
  xlab("Condition") + ylab("Relative Decision Weight") +
  geom_hline(yintercept = 0, linetype = 'solid') +
  scale_y_continuous(limits = c(-0.5, 0.5)) +
  ggtitle(" ") +
  # geom_text(aes(label = round(RDW, 3)), nudge_y = -0.04) + #Add text value on each bar
  theme_bw() + theme(aspect.ratio = 0.75, axis.text = element_text(size = 15), axis.title = element_text(size = 18)) 
  
  
# Save as png with transparent background
ggsave( plot = plot.nsf.RDW ,
        filename = "img/nsf/NSF_relativeDecisionWeights.png",
        bg = "transparent")


# Remove placeholder variables from global
rm(WR_RDW.nsf);rm(TSD_RDW.nsf);rm(SR_RDW.nsf);rm(nsf.temp.RDW);rm(LogLLA);rm(LogBaserate)

```

## Check proportion of easy to hard trials (Easy trials are those with post_prob >.8 or <.2)

Number of easy trials = 850
Number of hard trials = 1870
Proportion that are easy = 31.25%


END