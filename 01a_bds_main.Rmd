---
title: "**Main Data Analyses**"
output: html_notebook
---
### General Instructions
* Execute chunk by placing cursor within chunk and pressing *Ctrl+Shift+Enter*. 
* Execute a single line of code by placing cursor on that line, and pressing *Ctrl+Enter*
* Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.
* When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

```{r,echo=FALSE}

## Load Packages

library(dplyr)
library(readxl)
library(tidyr)


# Visualisation libraries
library(ggplot2)
library(ggsignif) # For significance bars on ggplots
library(visreg)

library(egg) # for ggarrange (panelling multiple ggplots)
library(lme4)
library(lmerTest)

library(brms)
library(emmeans)


library(aod)
library(car)   # For Chi-square test of Coefficient Equality `linearHypothesis`
library(MuMIn)
library(performance) # for check_collinearity function
library(sjPlot) # This gives a summary output of the model in APA style. Use `tab_model(model)`


library(piecewiseSEM)
library(DHARMa)


install.packages('robustlmm')

# Turn off scientific notation
options(scipen = 20)

```

# Data Management

```{r,echo=FALSE}

# Read bds.data
bds.data <- read.csv("./data/BDS_study_data/data_master.csv")


# Check for duplicates
bds.data[duplicated(bds.data),]


```



## Factorize and label Condition and Session

```{r,echo=FALSE}
# Convert Condition to factor

bds.data$Condition <- factor(bds.data$Condition,
                         levels = c(1, 2, 3),
                         labels = c("WR", "SR", "CM")
)

# convert Session to factor
bds.data$SessionTime <- factor(bds.data$SessionTime,
                       levels = c(1,2),
                       labels = c("AM", "PM")
                       )


```

## Subset bds.data

```{r,echo=FALSE}

# Subset bds.data into SR and CM
bds.data.SR =  subset(bds.data, Condition == 'WR'|Condition == 'SR')
bds.data.CM =  subset(bds.data, Condition == 'WR'| Condition == 'CM')

# Split each subset further into AM and PM sessions

bds.data.SR.AM = subset(bds.data.SR, SessionTime == 'AM')
bds.data.SR.PM = subset(bds.data.SR, SessionTime == 'PM')
bds.data.CM.AM = subset(bds.data.CM, SessionTime == 'AM')
bds.data.CM.PM = subset(bds.data.CM, SessionTime == 'PM')


# Create subset of  SR bds.data without the NoBrainers
bds.data.SR2 <- subset(bds.data.SR, NoBrainers == 0 )
bds.data.CM2 <- subset(bds.data.CM, NoBrainers == 0 )
# Split each subset into AM and PM sessions
bds.data.SR.AM2 <- subset(bds.data.SR2, SessionTime == 'AM')
bds.data.SR.PM2 <- subset(bds.data.SR2, SessionTime == 'PM')
# Split each subset into AM and PM sessions
bds.data.CM.AM2 <- subset(bds.data.CM2, SessionTime == 'AM')
bds.data.CM.PM2 <- subset(bds.data.CM2, SessionTime == 'PM')


# Create subset of SR/CM bds.data with HARD trials

bds.data.SR3 <- subset(bds.data.SR, IsEasy == 0)
bds.data.CM3 <- subset(bds.data.CM, IsEasy == 0)
# Split each subset into AM and PM sessions
bds.data.SR.AM3 <- subset(bds.data.SR3, SessionTime == 'AM')
bds.data.SR.PM3 <- subset(bds.data.SR3, SessionTime == 'PM')
# Split each subset into AM and PM sessions
bds.data.CM.AM3 <- subset(bds.data.CM3, SessionTime == 'AM')
bds.data.CM.PM3 <- subset(bds.data.CM3, SessionTime == 'PM')

# Creat subset of SR/CM bds.data with Easy trials

bds.data.SR4 <- subset(bds.data.SR, IsEasy == 1)
bds.data.CM4 <- subset(bds.data.CM, IsEasy == 1)
# Split each subset into AM and PM sessions
bds.data.SR.AM4 <- subset(bds.data.SR4, SessionTime == 'AM')
bds.data.SR.PM4 <- subset(bds.data.SR4, SessionTime == 'PM')
# Split each subset into AM and PM sessions
bds.data.CM.AM4 <- subset(bds.data.CM4, SessionTime == 'AM')
bds.data.CM.PM4 <- subset(bds.data.CM4, SessionTime == 'PM')



```


---

# **Sleep Restriction** Analyses

## Count number of participants who did the SR session

```{r,echo=FALSE}
SR_trials <- subset(bds.data.SR, Condition == 'SR')
length(unique(SR_trials$PtID)); rm(SR_trials)
```

## Manipulation check

```{r,echo=FALSE}

# Subset only necessary variables
bds.data.SR_KSS <-bds.data.SR[c("PtID", "SessionTime", "Condition", "StartKSS")]

# Keep unique values
bds.data.SR_KSS <- distinct(bds.data.SR_KSS)

# Preview bds.data
bds.data.SR_KSS

```

### Normality check of StartKSS variable
```{r,echo=FALSE}

KSS_plot <- ggplot(bds.data.SR_KSS, aes(x = StartKSS)) + geom_density()
KSS_plot       
shapiro.test(bds.data.SR_KSS$StartKSS)

```

### Transform KSS variable with Sqrt
```{r,echo=FALSE}
# Apply sqrt transformation
bds.data.SR_KSS$sqrtKSS <- sqrt(bds.data.SR_KSS$StartKSS)
# inspect plot
KSS_plot <- ggplot(bds.data.SR_KSS, aes(x = sqrtKSS)) + geom_density()
KSS_plot
# Shapiro test
shapiro.test(bds.data.SR_KSS$sqrtKSS)

```



### Create model

```{r,echo=FALSE}
# Create model
SR_KSS <- lmer(sqrtKSS ~ 1 + SessionTime*Condition + (1|PtID),
               data = bds.data.SR_KSS)
summary(SR_KSS)

SR_KSS2 <- lmer(sqrtKSS ~ 1 + SessionTime + (1|PtID),
                data= bds.data.SR_KSS[bds.data.SR_KSS$Condition == 'SR',])
summary(SR_KSS2)

SR_KSS3 <- lmer(sqrtKSS ~ 1 + Condition + (1|PtID),
                data = bds.data.SR_KSS[bds.data.SR_KSS$SessionTime == 'PM',])
summary(SR_KSS3)

# Confidence Intervals
confint(SR_KSS, method="Wald",level = 0.95, oldNames="FALSE")


# Get R-squared
r.squaredGLMM(SR_KSS)
# Model output in APA style
tab_model(SR_KSS,
          show.est = TRUE,
          show.se = TRUE,
          string.se = "SE",
          string.ci = "95% CI",
          string.est = "Estimate")

# Check collinearity
check_collinearity(SR_KSS)

KSS_scores <- as.data.frame(
  lsmeans(SR_KSS, spec = c("Condition", "SessionTime", by = c("SessionTime")
                           ))
  )



KSS_plot  <-ggplot(KSS_scores, aes(x = SessionTime, y = lsmean, color = Condition)) + 
    geom_point(size = 3) + geom_line(aes(group = Condition)) + scale_y_continuous(limits = c(1, 3))+
    labs(title = "Sqrt KSS scores by Condition", x ="SessionTime", y = "Sqrt KSS Score") +
    scale_color_manual(values = c("#202A44", "#9F1D35")) +
    geom_errorbar(aes(ymin = KSS_scores$lower.CL, ymax = KSS_scores$upper.CL), color = '#595959', width = 0.1) +
    theme_bw()+theme(aspect.ratio = 0.9)

# Save as png with transparent background
ggsave( plot = KSS_plot,
        filename = "KSS_score.png",
        bg = "transparent")



```

### Check Residuals

```{r,echo=FALSE}
sim_output <- simulateResiduals(SR_KSS, plot = F)
plotQQunif(sim_output)
plotResiduals(sim_output)

```





## Trial accuracy on SR

```{r,echo=FALSE}

# Accuracy model with the NoBrainer trials

SR_Acc <- glmer(IsCorrect ~  1 + NoBrainers*Condition*SessionTime + (1|PtID),
                 family = binomial("logit"),
                 bds.data.SR)



# Accuracy model excluding NoBrainer trials

SR_Acc1 <-glmer(IsCorrect~ 1 + Condition*SessionTime + (1|PtID),
                family = binomial("logit"),
                bds.data.SR2)

summary(SR_Acc1)

#Accuracy model using IsEasy variable

SR_Acc3 <- glmer(IsCorrect ~ 1  + IsEasy*Condition*SessionTime + (1|PtID),
                 family = binomial("logit"),
                 bds.data.SR)
summary(SR_Acc3)
tab_model(SR_Acc3)


# Confidence Intervals
confint(SR_Acc1, method="Wald",level = 0.95, oldNames="FALSE")


# Get R-squared
r.squaredGLMM(SR_Acc1)
# Model output in APA style
tab_model(SR_Acc1,
          show.est = TRUE,
          show.se = TRUE,
          string.se = "SE",
          string.ci = "95% CI",
          string.est = "Estimate")

# Check collienarity
check_collinearity(SR_Acc1)

lsm <- lsmeans(SR_Acc1, spec = c("Condition", "SessionTime"),  by = c("Condition"), type = "response")
lsm <- as.data.frame(lsm)
lsm$Condition <- factor(lsm$Condition, levels = c("WR","SR"))
lsm$SessionTime <- factor(lsm$SessionTime, levels = c("AM","PM"))

lsm
lsm_acc_plot <- ggplot(lsm, aes(x = Condition, y = prob, color = SessionTime )) + 
  geom_point(size = 3) +
  scale_y_continuous(limits = c(0.5, 1)) +
  labs(title = "Trial Accuracy by AM/PM Sessions", x = "Condition", y = "Probability of Accurate Response") +
  scale_color_manual(values = c("#202A44", "#9F1D35")) + 
  geom_errorbar(aes(ymin = lsm$asymp.LCL, ymax = lsm$asymp.UCL), color = '#595959', width = 0.1) + 

  theme_bw()+theme(aspect.ratio = 1.5) 

# Make facet plot 
lsm_facet <- lsm_acc_plot + facet_wrap(~SessionTime, ncol = 2)  
lsm_facet

# Save as png with transparent background
ggsave( plot = lsm_facet,
        filename = "trial_accuracy.png",
        bg = "transparent")


 
```
### Check Residuals

```{r,echo=FALSE}
sim_output <- simulateResiduals(SR_Acc1, plot = F)

plotQQunif(sim_output)

plotResiduals(sim_output)


```


## Pooled SR model , with Session as covariate + 3-way interactions

```{r,echo=FALSE}

# Pooled AM and PM model

SR_pooled <- glmer (PtResp ~ 1 + Condition*LogLLA + Condition*LogBaserate + (1 |PtID),
                    family = binomial('probit'),
                    bds.data.SR)
summary(SR_pooled)

# Create model with 3 way interaction
SR1 <- glmer(PtResp ~ 1 + SessionTime*Condition*LogLLA + SessionTime*Condition*LogBaserate + (1|PtID),
             family = binomial('probit'),
             bds.data.SR
             )

# Print summary
summary(SR1)


# Confidence Intervals
confint(SR1, method="Wald",level = 0.95, oldNames="FALSE")


# Get R-squared
r.squaredGLMM(SR1)
# Model output in APA style
tab_model(SR1,
          transform = NULL,
          show.est = TRUE,
          show.se = TRUE,
          string.se = "SE",    
          string.ci = "95% CI", string.est = "Estimate")



# Check collienarity
check_collinearity(SR1)

```

### Residual diagnostics

```{r,echo=FALSE}
sim_output <- simulateResiduals(SR1, plot = F)
plotQQunif(sim_output)
plotResiduals(sim_output)


qqnorm(resid(SR1));qqline(resid(SR1))
```

## AM-only

```{r,echo=FALSE}

# Create model
SR_AM1 <- glmer(PtResp ~ 1 + Condition*LogLLA + Condition*LogBaserate + (1|PtID),
             family = binomial('probit'),
             bds.data.SR.AM
             )


# Print summary
summary(SR_AM1)


# Confidence Intervals
confint(SR_AM1, method="Wald",level = 0.95, oldNames="FALSE")


# Get R-Squared

anova(SR_AM1)

# Model output in APA style
tab_model(SR_AM1,
          transform = NULL,
          show.est = TRUE,
          show.se = TRUE,
          string.se = "SE",      
          string.ci = "95% CI",
          string.est = "Estimate"
          )



# Check collienarity
check_collinearity(SR_AM1)


```

### Check Residuals

```{r,echo=FALSE}

sim_output <- simulateResiduals(SR_AM1, plot = T)
plotQQunif(sim_output)
plotResiduals(sim_output)

ggplot(data.frame(eta=predict(SR_AM1,type="link"),pearson=residuals(SR_AM1,type="pearson")),
      aes(x=eta,y=pearson)) +
    geom_point() +
    theme_bw()

```


### Chi-Square Tests of Coefficient Equality

```{r,echo=FALSE}

# Chi-square tests
linearHypothesis(SR_AM1, c(" LogBaserate =  LogLLA"), 
                 rhs=NULL, vcov.=NULL, singular.ok=FALSE, verbose=FALSE
                 )

linearHypothesis(SR_AM1, c(" ConditionSR:LogBaserate =  ConditionSR:LogLLA"), 
                 rhs=NULL,vcov.=NULL, singular.ok=FALSE, verbose=FALSE
                 )



```
### Calculate and plot decision weights
```{r,echo=FALSE}


# Calculate relative decision-weights

LogLLA <- 0.17922 
LogBaserate <- 0.20753
SR_LogLLA <- LogLLA + -0.03275 
SR_LogBaserate <- LogBaserate + -0.01891  

# During WR
WR_AM_RDW <- (LogLLA - LogBaserate )/ (LogLLA + LogBaserate)
# During SR
SR_AM_RDW <- (SR_LogLLA - SR_LogBaserate)/(SR_LogLLA + SR_LogBaserate)

condition <- c("WR_AM", "SR_AM")
relative_dw <- c(WR_AM_RDW, SR_AM_RDW)

SR_AM_df <- data.frame(condition, relative_dw)
SR_AM_df


```

## PM-only

```{r,echo=FALSE}

# Create model
SR_PM1 <- glmer(PtResp ~ 1 + Condition*LogLLA + Condition*LogBaserate + (1|PtID),
             family = binomial('probit'),
             bds.data.SR.PM
             )

# Print summary
summary(SR_PM1)

## Confidence Intervals
confint(SR_PM1, method="Wald",level = 0.95, oldNames="FALSE")


# Get R-Squared 
r.squaredGLMM(SR_PM1)
# Model output in APA style
tab_model(SR_PM1,
          transform = NULL,
          show.est = TRUE,
          show.se = TRUE,
          string.se = "SE",         
          string.ci = "95% CI",
          string.est = "Estimate")



# Check collienarity
check_collinearity(SR_PM1)


```

### Check Residuals

```{r,echo=FALSE}
sim_output <- simulateResiduals(SR_PM1, plot = F)
plotQQunif(sim_output)
plotResiduals(sim_output)

hist(resid(SR_PM1), breaks = seq(from=-5, to = 6, by=0.3))
plot(fitted(SR_PM1), resid(SR_PM1));abline(0,0)
```

### Chi-Square Tests of Coefficient Equality

```{r,echo=FALSE}

# Chi-square tests
linearHypothesis(SR_PM1, c(" LogBaserate =  LogLLA"), rhs=NULL,
                 vcov.=NULL, singular.ok=FALSE, verbose=FALSE)

linearHypothesis(SR_PM1, c(" ConditionSR:LogBaserate =  ConditionSR:LogLLA"), rhs=NULL,
                 vcov.=NULL, singular.ok=FALSE, verbose=FALSE)



```


### Calculate and plot decision weights
```{r,echo=FALSE}

# Calculate relative decision-weights

LogLLA <- 0.15994 
LogBaserate <- 0.20440
SR_LogLLA <- LogLLA + -0.03201
SR_LogBaserate <- LogBaserate + 0.12591 

# During WR
WR_PM_RDW <- (LogLLA - LogBaserate )/ (LogLLA + LogBaserate)
# During SR
SR_PM_RDW <- (SR_LogLLA - SR_LogBaserate)/(SR_LogLLA + SR_LogBaserate)

condition <- c("WR_PM", "SR_PM")
relative_dw <- c(WR_PM_RDW, SR_PM_RDW)

SR_PM_df <- data.frame(condition, relative_dw)
SR_PM_df


```


# Analyses Excluding NoBrainer Trials
## Pooled SR Model without the NoBrainer trials (convergence issue)
```{r,echo=FALSE}

SR2 <- glmer(PtResp ~ 1 + SessionTime*Condition*LogLLA + SessionTime*Condition*LogBaserate + (1|PtID),
             family = binomial('probit'),
             control = glmerControl(boundary.tol = 1e10, tolPwrss = 5e-2),
             data = bds.data.SR2
)
            
summary(SR2)
```

## AM-only model without NoBrainers 
```{r,echo=FALSE}


# Create model
SR_AM2 <- glmer(PtResp ~ 1 + Condition*LogLLA + Condition*LogBaserate + 
                  (1 |PtID),
             family = binomial('probit'),
             bds.data.SR.AM2
             )

# Print summary
summary(SR_AM2)


# Confidence Intervals
confint(SR_AM2, method="Wald",level = 0.95, oldNames="FALSE")

# Model output in APA style
tab_model(SR_AM2,         
          transform = NULL,
          show.est = TRUE,
          show.se = TRUE,
          string.se = "SE",
          string.ci = "95% CI",
          string.est = "Estimate")


# Check collienarity
check_collinearity(SR_AM2)

```





### Check Residuals

```{r,echo=FALSE}
sim_output <- simulateResiduals(SR_AM2, plot = F)
plotQQunif(sim_output)
plotResiduals(sim_output)

```
### Decision Weight Analyses
```{r,echo=FALSE}

# Chi-square tests
linearHypothesis(SR_AM2, c(" LogBaserate =  LogLLA"), rhs=NULL,
                 vcov.=NULL, singular.ok=FALSE, verbose=FALSE)

linearHypothesis(SR_AM2, c(" ConditionSR:LogBaserate =  ConditionSR:LogLLA"), rhs=NULL,
                 vcov.=NULL, singular.ok=FALSE, verbose=FALSE)



```
### Calculate and plot decision weights
```{r,echo=FALSE}

# Calculate relative decision-weights

LogLLA <- 0.30879 
LogBaserate <- 0.77677 
SR_LogLLA <- LogLLA + -0.06359
SR_LogBaserate <- LogBaserate + -0.12544

# During WR
WR_AM_RDW <- (LogLLA - LogBaserate )/ (LogLLA + LogBaserate)
# During SR
SR_AM_RDW <- (SR_LogLLA - SR_LogBaserate)/(SR_LogLLA + SR_LogBaserate)

condition <- c("WR_AM", "SR_AM")
relative_dw <- c(WR_AM_RDW, SR_AM_RDW)

SR_AM_df <- data.frame(condition, relative_dw)
SR_AM_df$condition = factor(SR_AM_df$condition, levels = c("WR_AM", "SR_AM"))


# Plot the decision
         
AM_rdw_plot <- ggplot(data=SR_AM_df, aes(x = condition, y = relative_dw)) + 
  geom_bar(
    stat ="identity", 
    width = 0.4, fill= c("#202A44", "#453324")
    ) +
  xlab("Condition") + ylab("") +    # Rename x and y axes
  geom_hline(yintercept = 0, linetype = 'dashed') +  # adds line on yintercept = 0
  scale_y_continuous(limits = c(-.6,.6))+   # set y axis limits
  ggtitle("Relative Decision Weights (AM)") +  # add title
  geom_text(aes(label = round(relative_dw, 2)), nudge_y = -0.04)+  # add text values of each bars
  geom_signif(comparisons = list(c("WR_AM", "SR_AM")), annotations = "N.S.", y_position = .1) + # Add significance lines
  theme_bw() + theme(aspect.ratio =  1) 

AM_rdw_plot

```



## PM-only model without NoBrainers 
```{r,echo=FALSE}

# Create model
SR_PM2 <- glmer(PtResp ~ 1 + Condition*LogLLA + Condition*LogBaserate + (1|PtID),
             family = binomial('probit'),
             bds.data.SR.PM2
             )

# Print summary
summary(SR_PM2)


# Confidence Intervals
confint(SR_PM2, method="Wald",level = 0.95, oldNames="FALSE")


# Model output in APA style
tab_model(SR_PM2,
          transform = NULL,
          show.est = TRUE,
          show.se = TRUE,
          string.se = "SE",
          string.ci = "95% CI",
          string.est = "Estimate")


# Check collienarity
check_collinearity(SR_PM2)


```
### Check Residuals

```{r,echo=FALSE}

# Check residuals
sim_output <- simulateResiduals(SR_PM2, plot = F)
plotQQunif(sim_output)
plotResiduals(sim_output)
```

```{r, echo = FALSE}

condition <- c("WR", "WR", "SR", "SR", "WR", "WR", "SR", "SR")
session <- c(rep("AM", 4), rep("PM", 4))
information <-  c(rep(c("LogLLA", "LogBR"), 4))

coefficients <- c(0.30879,  0.77677,  0.2452,  0.65133,  0.29171,  0.72799,  0.23351,  0.77166  )

se_lower <- c(0.28761,  0.73181,  0.21407,  0.58405,  0.27113,  0.6843,  0.20264,  0.70358  )

se_upper <- c(0.32997,  0.82173,  0.27633,  0.71861,  0.31229,  0.77168,  0.26438,  0.83974  )

ci_lower <- c(0.2672815,0.6886429,0.1841902,0.5194604,0.25137681,0.64235532,0.17300985,0.63821854)
ci_upper <-c(0.350304,0.864895588,0.306202423,0.783197672,0.332046028,0.813631264,0.294015979,0.905105997)

decision_weights <- tibble(condition, session, information, coefficients, se_lower, se_upper, ci_lower, ci_upper)
decision_weights
decision_weights$condition <- factor(decision_weights$condition, levels = c("WR","SR"))
decision_weights$session <- factor(decision_weights$session, levels = c("AM", "PM"))
decision_weights$information <- factor(decision_weights$information, levels = c("LogLLA", "LogBR"))


dw_plot <- ggplot(data = decision_weights, aes( x = condition, y = coefficients , color =  information)) + 
  geom_point(size=  2.5) + 
  scale_y_continuous(limits = c(0.0,1)) +
  
  labs(title = "Decision Weights by AM/PM Sessions", x = "Condition", y = "Weight", color = "Information")+
  scale_color_manual(labels = c("Log Likelihood", "Log Prior Odds"), values = c("blue", "red"))+
  
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), color = '#595959', width = 0.1)+ # Add error bars
  theme_bw() + theme(aspect.ratio =  1.5)  

facet_plot <- dw_plot + facet_wrap(~session, ncol = 2)

facet_plot
# Save as png with transparent background
ggsave( plot = facet_plot,
        filename = "decision_weights.png",
        bg = "transparent")


```

### Decision Weight Analyses
```{r,echo=FALSE}

# Chi-square tests
linearHypothesis(SR_PM2, c(" LogBaserate =  LogLLA"), rhs=NULL,
                 vcov.=NULL, singular.ok=FALSE, verbose=FALSE)

linearHypothesis(SR_PM2, c(" ConditionSR:LogBaserate =  ConditionSR:LogLLA"), rhs=NULL,
                 vcov.=NULL, singular.ok=FALSE, verbose=FALSE)



```
### Calculate and plot decision weights

```{r,echo=FALSE}


# Calculate relative decision-weights

LogLLA <- 0.29171 
LogBaserate <- 0.72799 
SR_LogLLA <- LogLLA + -0.05820
SR_LogBaserate <- LogBaserate + 0.04367 

# During WR
WR_PM_RDW <- (LogLLA - LogBaserate )/ (LogLLA + LogBaserate)
# During SR
SR_PM_RDW <- (SR_LogLLA - SR_LogBaserate)/(SR_LogLLA + SR_LogBaserate)

condition <- c("WR_PM", "SR_PM")
relative_dw <- c(WR_PM_RDW, SR_PM_RDW)

SR_PM_rdw <- tibble(condition, relative_dw)
SR_PM_rdw

SR_PM_rdw$condition = factor(SR_PM_rdw$condition, levels = c("WR_PM", "SR_PM"))

                             
# Plot the decision
PM_rdw_plot <- ggplot(data=SR_PM_rdw, aes(x = condition, y = relative_dw)) + 
  geom_bar(
    stat ="identity", 
    width = 0.4, fill= c("#202A44", "#453324")
    ) +
  xlab("Condition") + ylab("") +    # Rename x and y axes
  geom_hline(yintercept = 0, linetype = 'dashed') +  # adds line on yintercept = 0
  scale_y_continuous(limits = c(-.6,.6))+   # set y axis limits
  ggtitle("Relative Decision Weights (PM)") +  # add title
  geom_text(aes(label = round(relative_dw, 2)), nudge_y = -0.04)+  # add text values of each bars
  
  geom_signif(comparisons = list(c("WR_PM", "SR_PM")), annotations = "N.S.", y_position = .1)+
  theme_bw() + theme(aspect.ratio =  1) 


PM_rdw_plot
rdw_plots <- ggarrange(AM_rdw_plot, PM_rdw_plot, ncol = 2 , nrow = 1)


# Save as png with transparent background
ggsave( plot = rdw_plots,
        filename = "rel_decision_weights.png",
        bg = "transparent")


#plot model

```


---

## Analyses on non-Easy and Easy trials
```{r}


# Create model
SR_AM3 <- glmer(PtResp ~ 1 + Condition*LogLLA + Condition*LogBaserate + 
                  (1 |PtID),
             family = binomial('probit'),
             bds.data_SR_AM3
             )

summary(SR_AM3)

```


### Residuals Test
```{r}
#Residuals tests
sim_output <- simulateResiduals(SR_PM2, plot = F)
plotQQunif( sim_output)
plotResiduals(sim_output)

```

### Coefficients test
```{r}
# Chi-square tests
linearHypothesis(SR_AM3, c(" LogBaserate =  LogLLA"), rhs=NULL,
                 vcov.=NULL, singular.ok=FALSE, verbose=FALSE)

linearHypothesis(SR_AM3, c(" ConditionSR:LogBaserate =  ConditionSR:LogLLA"), rhs=NULL,
                 vcov.=NULL, singular.ok=FALSE, verbose=FALSE)


```


PM session

```{r}
SR_PM3 <-glmer(PtResp ~ 1 + Condition*LogLLA + Condition*LogBaserate + 
                  (1 |PtID),
             family = binomial('probit'),
             bds.data_SR_PM3
             )

summary(SR_PM3)
tab_model(SR_PM3)

```

### Residuals Test
```{r}
#Residuals tests
sim_output <- simulateResiduals(SR_PM3, plot = F)
plotQQunif( sim_output)
plotResiduals(sim_output)

```

### Coefficients test
```{r}
# Chi-square tests

linearHypothesis(SR_PM3, c(" LogBaserate =  LogLLA"), rhs=NULL,
                 vcov.=NULL, singular.ok=FALSE, verbose=FALSE)

linearHypothesis(SR_PM3, c(" ConditionSR:LogBaserate =  ConditionSR:LogLLA"), rhs=NULL,
                 vcov.=NULL, singular.ok=FALSE, verbose=FALSE)


```

---

## Test `brms` code

```{r,echo=FALSE}

brm_test <- brm(formula = PtResp| trials(35)~
                   1 + Condition*LogLLA + Condition*LogBaserate + 
                  (1 + Condition*LogLLA + Condition*LogBaserate|PtID),
                 bds.data = bds.data_SR_AM2,
                 family = binomial(link='logit'),
                 warmup = 1000,
                iter = 4000,
                chains = 4,
                init = "random",
                backend = getOption("cmdstanr"),
                cores = 4)

summary(brm_test)

exp(0.17)/(1+exp(.17))


```

---

# **Circadian Misalignment** Analyses

### Count no. of pts who completed CM condition

```{r,echo=FALSE}

CM_trials<-subset(bds.data_CM , Condition == "CM")
length(unique(CM_trials$ID))

```


